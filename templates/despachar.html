{% extends "base.html" %}
{% block title %}Nombre de la p√°gina{% endblock %}
{% block content %}


<main>
  <div class="card mb-4">
    <div class="card-body">
      <h2>Despachar Pedido</h2>
      <div id="reader-container" style="display:flex; justify-content:center; margin-top:1rem;">
        <div id="reader" style="width:320; height:240;"></div>
      </div>
      <div style="text-align:center; margin-top:0.5rem;">
        <button id="stop-btn" class="btn">Detener escaneo</button>
      </div>
      <hr style="margin: 2rem 0;">
      <p><strong>O sub√≠ una imagen de QR:</strong></p>
      <input type="file" id="input-escanear" accept="image/*" class="mt-1"><br><br>
      <p><strong>O ingres√° el ID manualmente:</strong></p>
      <div style="display:flex; align-items:center;">
        <input type="text" id="manual-id" placeholder="Ingresar ID de pedido"
          style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px;">
        <button class="btn" id="btn-manual" style="margin-left:1rem;">Buscar</button>
      </div>
    </div>
  </div>

  <div id="detalle-pedido" class="card mb-4" style="display:none;">
    <div class="card-body">
      <h3>Detalle del Pedido</h3>
      <p><strong>Cliente:</strong> <span id="cliente"></span></p>
      <p><strong>Estado del Env√≠o:</strong> <span id="estado_envio"></span></p>
      <table class="detail-table desktop-only">
        <thead>
          <tr>
            <th style="text-align:left; padding:0.5rem;">Imagen</th>
            <th style="text-align:left; padding:0.5rem;">T√≠tulo</th>
            <th style="text-align:left; padding:0.5rem;">SKU</th>
            <th style="text-align:left; padding:0.5rem;">Variante</th>
            <th style="text-align:left; padding:0.5rem;">Cantidad</th>
          </tr>
        </thead>
        <tbody id="tabla-items-despachar"></tbody>
      </table>
      <div id="cards-items-despachar" class="mobile-only"></div>
      <hr class="section-divider" />

      <form id="despachar-form" method="post" action="/despachar">
        <input type="hidden" id="order_id_hidden" name="order_id" value="">
        <input type="hidden" id="shipment_id_hidden" name="shipment_id" value="">
        <div style="margin-top:1rem;">
          <label for="logistica">Log√≠stica</label>
          <select id="logistica" name="logistica" required>
            <option value="" disabled selected>Seleccione una log√≠stica</option>
            {% for l in logisticas %}
            <option value="{{ l }}">{{ l }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="margin-top:1rem;">
          <label for="tipo_envio">Tipo de Env√≠o</label>
          <select id="tipo_envio" name="tipo_envio" required>
            <option value="" disabled selected>Seleccione tipo de env√≠o</option>
            <option value="Flex">Flex</option>
            <option value="Colecta">Colecta</option>
          </select>
        </div>
        <button type="submit" style="margin-top:1.5rem;">Despachar Pedido</button>
      </form>

      <div id="message" class="mt-3"></div>
    </div>
  </div>
</main>

{% endblock %}

{% block scripts %}
<script src="/static/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

let scanner;
let escaneoActivo = true;
let ultimoOrderId = "";
let ultimoShipId = "";

/* ===== Toasts ===== */
function mostrarToast(tipo, mensaje) {
  const toast = document.getElementById("toast-alert");
  const body  = document.getElementById("toast-body");
  toast.classList.remove("success","error");
  toast.classList.add(tipo === "success" ? "success" : "error");
  body.innerText = mensaje;
  toast.classList.add("show");
}
const mostrarToastSuccess = (msg) => mostrarToast("success", msg);
const mostrarToastError   = (msg) => mostrarToast("error", msg);
function ocultarToast() {
  const toast = document.getElementById("toast-alert");
  toast.classList.remove("show");
}

/* ===== QR ===== */
async function iniciarEscaneo() {
  if (!scanner) scanner = new Html5Qrcode("reader");
  escaneoActivo = true;
  try {
    await scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 220, height: 220 } },
      async (decodedText) => {
        console.log("‚úÖ QR le√≠do:", decodedText);
        await detenerEscaneo();
        await escanear(decodedText);
      },
      (_) => { /* fallas silenciosas */ }
    );
    document.getElementById("stop-btn").innerText = "Detener escaneo";
    console.log("üé• Escaneo iniciado");
  } catch (err) {
    console.error("‚ùå Error iniciando escaneo:", err);
    escaneoActivo = false;
  }
}

async function detenerEscaneo() {
  if (!scanner) return;
  try { await scanner.stop(); } catch (_) {}
  escaneoActivo = false;
  document.getElementById("stop-btn").innerText = "Reiniciar escaneo";
}

/* ===== Render detalle ===== */
function mostrarDetalle(detalle) {
  document.getElementById("cliente").innerText = detalle.cliente;
  document.getElementById("estado_envio").innerText = detalle.estado_envio || "Desconocido";

  const tabla = document.getElementById("tabla-items-despachar");
  const cards = document.getElementById("cards-items-despachar");
  tabla.innerHTML = "";
  cards.innerHTML = "";

  detalle.items.forEach(item => {
    const imgUrl = Array.isArray(item.imagenes) && item.imagenes.length
      ? item.imagenes[0].thumbnail
      : "https://via.placeholder.com/150";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td style="text-align:center; padding:0.5rem; border-bottom:1px solid #eee;">
        <img src="${imgUrl}" width="80" style="border-radius:4px;">
      </td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">
        ${item.permalink
          ? `<a href="${item.permalink}" target="_blank" style="text-decoration:none; color:#007bff;">${item.titulo}</a>`
          : item.titulo}
      </td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.sku}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.variante}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.cantidad}</td>
    `;
    tabla.appendChild(row);

    const card = document.createElement("div");
    card.className = "detalle-card";
    card.innerHTML = `
      <div class="detalle-titulo">${item.titulo}</div>
      <img src="${imgUrl}" alt="Imagen del producto">
      <div class="detalle-info">
        <div><strong>SKU:</strong> ${item.sku}</div>
        <div><strong>Variante:</strong> ${item.variante}</div>
        <div><strong>Cantidad:</strong> ${item.cantidad}</div>
        ${item.permalink ? `<a href="${item.permalink}" target="_blank" style="margin-top:0.5rem; display:inline-block; color:#007bff;">Ver publicaci√≥n</a>` : ""}
      </div>
    `;
    cards.appendChild(card);
  });

  ultimoOrderId = detalle.primer_order_id || "";
  document.getElementById("order_id_hidden").value = detalle.primer_order_id || "";
  document.getElementById("shipment_id_hidden").value = ultimoShipId || "";
  document.getElementById("detalle-pedido").style.display = "block";
}

/* ===== Llamados ===== */
async function escanear(raw) {
  console.log("üîç Llamado a escanear() con:", raw);
  let shipmentVal;
  try {
    const obj = JSON.parse(raw);
    shipmentVal = obj.id;
  } catch {
    shipmentVal = raw;
  }
  console.log("üì¶ shipment_id:", shipmentVal);

  ultimoShipId = shipmentVal;
  document.getElementById("shipment_id_hidden").value = shipmentVal;

  const form = new FormData();
  form.append("shipment_id", shipmentVal);

  try {
    const res = await fetch("/escanear", { method: "POST", body: form });
    const data = await res.json();
    console.log("üì• Respuesta de /escanear:", data);
    if (data.success) {
      mostrarDetalle(data.detalle);
    } else {
      mostrarToastError(data.error || "No se pudo obtener el pedido.");
    }
  } catch (e) {
    console.error("‚ùå Error al llamar /escanear:", e);
    mostrarToastError("Error al obtener detalles del pedido.");
  }
}

async function buscarManual() {
  const id = document.getElementById("manual-id").value.trim();
  if (!id) {
    mostrarToastError("Por favor ingres√° un ID de env√≠o v√°lido.");
    return;
  }

  const form = new FormData();
  form.append("shipment_id", id);

  try {
    const res = await fetch("/escanear", {
      method: "POST",
      body: form,
      credentials: "include"
    });
    const data = await res.json();
    if (!data.success) {
      mostrarToastError(data.error || "No se pudo obtener el pedido.");
      return;
    }
    ultimoShipId = id;
    document.getElementById("shipment_id_hidden").value = id;
    mostrarDetalle(data.detalle);
  } catch {
    mostrarToastError("Error al conectar con el servidor.");
  }
}

/* ===== Init ===== */
window.addEventListener("DOMContentLoaded", () => {
  iniciarEscaneo();

  // Cerrar toast (null-safe)
  document.getElementById("toast-close-btn")?.addEventListener("click", ocultarToast);

  // Bot√≥n detener / reiniciar
  document.getElementById("stop-btn").addEventListener("click", async () => {
    const btn = document.getElementById("stop-btn");
    if (scanner && escaneoActivo) {
      try {
        await scanner.stop();
        escaneoActivo = false;
        btn.innerText = "Reiniciar escaneo";
      } catch (err) {
        console.error("‚ùå Error al detener el esc√°ner:", err);
      }
    } else {
      // Limpiar vista antes de reiniciar
      document.getElementById("detalle-pedido").style.display = "none";
      document.getElementById("tabla-items-despachar").innerHTML = "";
      document.getElementById("cliente").innerText = "";
      document.getElementById("estado_envio").innerText = "";
      document.getElementById("order_id_hidden").value = "";
      document.getElementById("shipment_id_hidden").value = "";
      ultimoShipId  = "";
      ultimoOrderId = "";
      iniciarEscaneo();
    }
  });

  // Escaneo desde imagen: parar, leer archivo, reanudar
  document.getElementById("input-escanear").addEventListener("change", async e => {
    if (!e.target.files.length) return;
    try {
      await detenerEscaneo();
      const qrImg = new Html5Qrcode("reader");
      const decoded = await qrImg.scanFile(e.target.files[0], true);
      await qrImg.clear();
      await escanear(decoded);
    } catch (err) {
      console.error(err);
      mostrarToastError("No se pudo leer el QR.");
    } finally {
      iniciarEscaneo();
    }
  });

  document.getElementById("btn-manual").addEventListener("click", () => buscarManual());

  // Submit despachar (loading en bot√≥n + recarga tras √©xito)
  document.getElementById("despachar-form").addEventListener("submit", async e => {
    e.preventDefault();

    // Refuerzo: asegurar valores
    document.getElementById("shipment_id_hidden").value = ultimoShipId;
    document.getElementById("order_id_hidden").value   = ultimoOrderId;

    if (!ultimoShipId) {
      mostrarToastError("No se detect√≥ un shipment_id v√°lido. Escane√° nuevamente.");
      return;
    }

    const submitBtn = e.target.querySelector('[type="submit"]');
    const originalText = submitBtn.innerText;
    let exito = false;

    // Estado "Despachando..."
    submitBtn.disabled = true;
    submitBtn.innerText = "Despachando‚Ä¶";

    const formData = new FormData(e.target);

    try {
      const resp = await fetch("/despachar", { method: "POST", body: formData /*, credentials: "include" */ });

      let data;
      try {
        data = await resp.json();
      } catch {
        const txt = await resp.text();
        console.error("Respuesta no JSON:", txt);
        mostrarToastError("Respuesta inv√°lida del servidor.");
        return;
      }

      if (!resp.ok || !data.success) {
        mostrarToastError(data.error || `Error ${resp.status || ""} al despachar.`);
        return;
      }

      exito = true;
      mostrarToastSuccess(data.mensaje || "Pedido despachado correctamente.");

      // Igual que en Escanear: breve delay para que se vea el toast y recargar
      setTimeout(() => window.location.reload(), 900);
    } catch (err) {
      console.error("‚ùå Error al conectar:", err);
      mostrarToastError("Error al conectar con el servidor.");
    } finally {
      // Si no hubo √©xito, restauramos el bot√≥n
      if (!exito) {
        submitBtn.disabled = false;
        submitBtn.innerText = originalText;
      
      }
    }
  });
});
</script>

{% endblock %}