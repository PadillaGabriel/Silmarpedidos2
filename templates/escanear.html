{% extends "base.html" %}
{% block title %}Escanear Pedido{% endblock %}
{% block content %}
<main>
  <div class="card mb-4">
    <div class="card-body">
      <h2>Escanear Pedido</h2>

      <div id="reader" style="width:100%; max-width:400px; height:300px; margin:1rem auto;"></div>
      <button id="stop-btn" class="btn btn-primary" style="display:block; margin:0 auto;">
        Detener escaneo
      </button>
      <hr style="margin:2rem 0;">

      <p><strong>O subí una imagen de QR:</strong></p>
      <input type="file" id="input-escanear" accept="image/*" class="mt-1"><br><br>

      <p><strong>O ingresá el ID manualmente:</strong></p>
      <div style="display:flex; align-items:center;">
        <input
          type="text"
          id="manual-id"
          placeholder="Ingresar ID de pedido"
          style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"
        >
        <button class="btn btn-primary" id="btn-manual" style="margin-left:1rem;">
          Buscar
        </button>
      </div>
    </div>
  </div>

  <div id="detalle-pedido" class="card" style="display:none; margin-top:2rem;">
    <div class="card-body">
      <h3>Detalle del Pedido</h3>
      <p><strong>Cliente:</strong> <span id="cliente"></span></p>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Imagen</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Título</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">SKU</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Variante</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Cantidad</th>
          </tr>
        </thead>
        <tbody id="tabla-items"></tbody>
      </table>

      <div style="text-align:center; margin-top:1rem;">
        <button id="boton-armar" class="btn btn-primary" style="display:none; width:100%;">
          Marcar como armado
        </button>
      </div>
      <div id="message-armar" class="mt-2"></div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script src="/static/html5-qrcode.min.js"></script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    let scanner;
    let ultimoShipId = "";

    function iniciarEscaneo() {
      Html5Qrcode.getCameras()
        .then(cameras => {
          if (!cameras.length) return alert("No hay cámaras disponibles.");
          const cameraId = cameras[0].id;
          scanner = new Html5Qrcode("reader");
          scanner.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            decoded => {
              scanner.stop().catch(console.error);
              escanear(decoded);
            },
            _ => {}
          ).catch(err => {
            console.error("Error al iniciar Html5Qrcode:", err);
            alert("No se pudo iniciar el escáner. Revisa permisos de cámara.");
          });
        })
        .catch(err => {
          console.error("Error al obtener cámaras:", err);
          alert("No se pudo acceder a la lista de cámaras.");
        });
    }

    // Listener para detener/reanudar escaneo
    document.getElementById("stop-btn").addEventListener("click", () => {
      if (scanner && scanner._isScanning) {
        scanner.stop()
          .then(() => document.getElementById("stop-btn").innerText = "Reanudar escaneo")
          .catch(console.error);
      } else {
        iniciarEscaneo();
        document.getElementById("stop-btn").innerText = "Detener escaneo";
      }
    });

    // Listener para subir imagen de QR
    document.getElementById("input-escanear").addEventListener("change", e => {
      if (!e.target.files.length) return;
      const qrImg = new Html5Qrcode("reader");
      qrImg.scanFile(e.target.files[0], true)
        .then(decoded => { qrImg.clear(); escanear(decoded); })
        .catch(() => alert("No se pudo leer el QR."));
    });

    // Listener para ingreso manual de ID
    document.getElementById("btn-manual").addEventListener("click", () => {
      const id = document.getElementById("manual-id").value.trim();
      if (id) escanear(id);
    });

    // Función que maneja el escaneo o entrada manual
    async function escanear(raw) {
      const { order_id, shipment_id } = parseQr(raw);
      console.log("Llamando a /escanear con shipment_id:", shipment_id);
      ultimoShipId = shipment_id;
      if (!shipment_id) {
        return alert("El QR no incluye un shipment_id válido.");
      }
      const form = new FormData();
      form.append("shipment_id", shipment_id);
      try {
        const res = await fetch("/escanear", {
          method: "POST",
          body: form,
          credentials: "include"
        });
        console.log("Respuesta /escanear status:", res.status);
        if (!res.ok) {
          const errText = await res.text();
          return alert("(" + res.status + ") " + errText);
        }
        const data = await res.json();
        document.getElementById("cliente").innerText = data.detalle.cliente;
        const tabla = document.getElementById("tabla-items");
        tabla.innerHTML = "";
        data.detalle.items.forEach(item => {
          const imgUrl = (Array.isArray(item.imagenes) && item.imagenes.length)
            ? item.imagenes[0].thumbnail
            : "https://via.placeholder.com/150";
          const row = document.createElement("tr");
          row.innerHTML = `
            <td style="text-align:center; padding:0.5rem; border-bottom:1px solid #eee;">
              <img src="${imgUrl}" width="80" style="border-radius:4px;">
            </td>
            <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.titulo}</td>
            <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.sku || ""}</td>
            <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.variante || ""}</td>
            <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.cantidad}</td>
          `;
          tabla.appendChild(row);
        });
        document.getElementById("detalle-pedido").style.display = "block";
        document.getElementById("boton-armar").style.display = "inline-block";
      } catch (err) {
        console.error(err);
        alert("Error al obtener detalles del pedido.");
      }
    }

    function parseQr(decoded) {
      let order_id = null, shipment_id = null;
      if (decoded.trim().startsWith("{")) {
        try {
          const payload = JSON.parse(decoded);
          if (payload.id) {
            shipment_id = payload.id;
            return { order_id: null, shipment_id };
          }
        } catch {}
      }
      try {
        const url = new URL(decoded);
        const parts = url.pathname.split("/").filter(p => p);
        if (parts[0] === "shipments") {
          shipment_id = parts[1] || null;
        } else if (parts[0] === "orders") {
          order_id = parts[1] || null;
        }
        return { order_id, shipment_id };
      } catch {}
      order_id = decoded.trim();
      return { order_id, shipment_id: null };
    }

    // ***** Aquí: listener para "boton-armar" *****
    document.getElementById("boton-armar").addEventListener("click", () => {
      console.log("→ Click en 'Marcar como armado', ultimoShipId =", ultimoShipId);
      if (!ultimoShipId) {
        return alert("No hay ningún shipment_id válido para marcar como armado.");
      }
      const form = new FormData();
      form.append("shipment_id", ultimoShipId);
      fetch("/armar", {
        method: "POST",
        body: form,
        credentials: "include"
      })
        .then(r => {
          console.log("JS → respuesta /armar status:", r.status);
          return r.json();
        })
        .then(resp => {
          console.log("JS → resp JSON /armar:", resp);
          if (resp.success) {
            alert("Pedido(s) marcados como armado");
            window.location.reload();
          } else {
            alert(resp.error || "No se pudo marcar como armado");
          }
        })
        .catch(err => {
          console.error("JS → Error en fetch /armar:", err);
          alert("Error al marcar armado");
        });
    });

    iniciarEscaneo();
  });
</script>
{% endblock %}
