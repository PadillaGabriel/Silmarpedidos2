{% extends "base.html" %}
{% block title %}Escanear Pedido{% endblock %}
{% block content %}
<main>
  <div class="card mb-4">
    <div class="card-body">
      <h2>Escanear Pedido</h2>

      <div id="reader-container" style="display:flex; justify-content:center; margin:1rem auto;">
        <div id="reader" style="width:320; height:240;"></div>
      </div>
      <button id="stop-btn" class="btn btn-primary" style="display:block; margin:0 auto;">
        Detener escaneo
      </button>
      <hr style="margin:2rem 0;">

      <p><strong>O sub√≠ una imagen de QR:</strong></p>
      <input type="file" id="input-escanear" accept="image/*" class="mt-1"><br><br>

      <p><strong>O ingres√° el ID manualmente:</strong></p>
      <div style="display:flex; align-items:center;">
        <input type="text" id="manual-id" placeholder="Ingresar ID de pedido"
          style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px;">
        <button class="btn btn-primary" id="btn-manual" style="margin-left:1rem;">
          Buscar
        </button>
      </div>
    </div>
  </div>

  <div id="detalle-pedido" class="card" style="display:none; margin-top:2rem;">
    <div class="card-body">
      <h3>Detalle del Pedido</h3>
      <p><strong>Cliente:</strong> <span id="cliente" class="badge bg-secondary"></span></p>
      <p><strong>Estado del Env√≠o:</strong> <span id="estado_envio" class="badge"></span></p>
      <!-- Tabla solo visible en escritorio -->
      <table class="desktop-only" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Imagen</th>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">T√≠tulo</th>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">SKU</th>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Alfa</th>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Cantidad</th>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Variante</th>
            <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Checklist</th>
          </tr>
        </thead>
        <tbody id="tabla-items-despachar"></tbody>
      </table>

      <!-- Tarjetas solo visibles en celular -->


      <div id="cards-items-despachar" class="mobile-only"></div>
      <div style="text-align:center; margin-top:1rem;">
        <button id="boton-armar" class="btn btn-primary" style="display:none; width:100%;" disabled>
          Marcar como armado
        </button>
      </div>
      <input type="hidden" id="shipment_id_hidden">
      <div id="message-armar" class="mt-2"></div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script src="/static/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // static/escanear.js
  let scanner;
  let escaneoActivo = false;
  let ultimoShipId = "";

function mostrarToast(mensaje, tipo="error") {
  const toast = document.getElementById("toast-alert");
  const body = document.getElementById("toast-body");
  if (!toast || !body) { alert(mensaje); return; } // guard
  body.innerText = mensaje;
  toast.classList.toggle("ok", tipo === "ok");
  toast.classList.add("show");
  toast.style.display = "block";
}
function mostrarToastError(m) { mostrarToast(m, "error"); }
function mostrarToastOk(m) { mostrarToast(m, "ok"); }
function ocultarToast() {
  const toast = document.getElementById("toast-alert");
  if (toast) { toast.classList.remove("show"); toast.style.display = "none"; }
}



  // Iniciar escaneo con c√°mara
  async function iniciarEscaneo() {
    if (scanner) {
      try {
        await scanner.clear();  // Limpia el canvas anterior
      } catch (e) {
        console.warn("No se pudo limpiar scanner anterior:", e);
      }
    }

    scanner = new Html5Qrcode("reader");  // üîÅ Siempre nuevo

    escaneoActivo = true;
    try {
      await scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 220, height: 220 } },
        async (decodedText) => {
          console.log("‚úÖ QR le√≠do:", decodedText);
          await detenerEscaneo();
          await escanear(decodedText);
        },
        (errorMessage) => {
          // Lecturas fallidas silenciosas
        }
      );
      document.getElementById("stop-btn").innerText = "Detener escaneo";
      console.log("üé• Escaneo iniciado");
    } catch (err) {
      console.error("‚ùå Error iniciando escaneo:", err);
      escaneoActivo = false;
    }
  }

async function detenerEscaneo() {
  if (!scanner) return;
  try {
    await scanner.stop();      // si no estaba corriendo, el catch lo maneja
    escaneoActivo = false;
    document.getElementById("stop-btn").innerText = "Reiniciar escaneo";
    console.log("üì¥ Escaneo detenido correctamente");
  } catch (err) {
    console.warn("Stop benigno:", err);
  }
}

  // Escanear desde texto o QR
function parseQr(decoded) {
  let shipment_id = null, order_id = null;

  const txt = (decoded || "").trim();

  // JSON {"id": "..."} de etiqueta
  if (txt.startsWith("{")) {
    try {
      const obj = JSON.parse(txt);
      if (obj.id) shipment_id = String(obj.id);
    } catch {}
  } else {
    // URL https://.../shipments/{id}
    try {
      const url = new URL(txt);
      const parts = url.pathname.split("/").filter(Boolean);
      if (parts[0] === "shipments" && parts[1]) shipment_id = parts[1];
    } catch {
      // Texto pelado: puede ser order_id o shipment_id
      if (/^\d+$/.test(txt)) {
        // si no pod√©s distinguir, mand√° ambos
        order_id = txt;
        shipment_id = txt;
      } else {
        shipment_id = txt;
      }
    }
  }
  return { shipment_id, order_id };
}

async function escanear(raw) {
  const { shipment_id, order_id } = parseQr(raw);
  if (!shipment_id && !order_id) return mostrarToastError("No se detect√≥ un ID v√°lido.");

  if (shipment_id) ultimoShipId = shipment_id;

  const form = new FormData();
  if (shipment_id) form.append("shipment_id", shipment_id);
  if (order_id)    form.append("order_id", order_id);

  try {
    const res = await fetch("/escanear", { method: "POST", body: form, credentials: "include" });
    const data = await res.json();
    if (!data.success) return mostrarToastError(data.error || "Error al escanear.");
    renderDetalle(data.detalle);
  } catch (err) {
    console.error(err);
    mostrarToastError("Error al conectar con el servidor.");
  }
}

  // Renderizar detalle + checklist
function renderDetalle(detalle) {
  const tabla = document.getElementById("tabla-items-despachar");
  const cards = document.getElementById("cards-items-despachar");
  tabla.innerHTML = ""; cards.innerHTML = "";

  // ‚Üê actualizar siempre desde la respuesta del backend
  ultimoShipId = detalle.primer_shipment_id || detalle.shipment_id || ultimoShipId || "";

  document.getElementById("shipment_id_hidden").value = ultimoShipId;
  document.getElementById("cliente").innerText = detalle.cliente || "-";
  document.getElementById("estado_envio").innerText = detalle.estado_envio || "-";
  document.getElementById("detalle-pedido").style.display = "block";

  const items = Array.isArray(detalle.items) ? detalle.items : [];
  items.forEach(item => {
    const imgs = Array.isArray(item.imagenes) ? item.imagenes : [];
    const img0 = imgs[0] || {};
    const imgUrl = img0.secure_url || img0.url || img0.thumbnail || "https://via.placeholder.com/300";

    const card = document.createElement("div");
    card.className = "detalle-card";
    card.innerHTML = `
      <div class="detalle-titulo">${item.titulo || "-"}</div>
      <a href="${item.permalink || '#'}" target="_blank">
        <img src="${imgUrl}" alt="Imagen del producto" class="img-publicacion">
      </a>
      <div class="detalle-info">
        <div><strong>SKU:</strong> ${item.sku || "-"}</div>
        <div><strong>Alfa:</strong> ${item.item_vendorCode || item.alfa || "-"}</div>
        <div><strong>Cantidad:</strong> ${item.cantidad ?? "-"}</div>
        <div><strong>Variante:</strong> ${item.variante || "-"}</div>
        <div style="margin-top: 0.5rem;">
          <label>
            <input type="checkbox" class="check-item"
              data-item-id="${item.item_id || ''}"
              data-sku="${item.sku || ''}">
            Marcar como armado
          </label>
        </div>
      </div>`;
    cards.appendChild(card);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><a href="${item.permalink || '#'}" target="_blank">
        <img src="${imgUrl}" style="width:60px; border-radius:4px;" class="img-publicacion">
      </a></td>
      <td>${item.titulo || "-"}</td>
      <td>${item.sku || "-"}</td>
      <td>${item.item_vendorCode || item.alfa || "-"}</td>
      <td>${item.cantidad ?? "-"}</td>
      <td>${item.variante || "-"}</td>
      <td><input type="checkbox" class="check-item"
            data-item-id="${item.item_id || ''}"
            data-sku="${item.sku || ''}"></td>`;
    tabla.appendChild(row);
  });

  // checklist 
document.querySelectorAll(".check-item").forEach(input => {
  input.addEventListener("change", () => {
    const marcado = input.checked;
    input.closest("tr")?.classList.toggle("resaltado", marcado);
    input.closest(".detalle-card")?.classList.toggle("resaltado", marcado);
  });
});


  const btn = document.getElementById("boton-armar");
  btn.style.display = "block";
  btn.disabled = false;
}


  // Marcar como armado
async function marcarArmado() {
  if (!ultimoShipId) return mostrarToastError("No hay shipment_id v√°lido.");

  const btn = document.getElementById("boton-armar");
  const txt = btn.innerText;
  btn.disabled = true; btn.innerText = "Marcando...";

  const f = new FormData();
  f.append("shipment_id", ultimoShipId);

  try {
    const r = await fetch("/armar", { method: "POST", body: f, credentials: "include" });
    let data = {}; const ct = r.headers.get("content-type") || "";
    if (ct.includes("application/json")) data = await r.json();

    const okFlag = (d) => d?.success === true || d?.ok === true || d?.status === "ok" || d?.mensaje === "Armado OK";
    if (!r.ok || !okFlag(data)) throw new Error(data?.error || data?.mensaje || `HTTP ${r.status}`);

    mostrarToastOk("‚úÖ Pedido marcado como ARMADO.");
    setTimeout(() => location.reload(), 1200);
  } catch (e) {
    mostrarToastError("No se pudo marcar como armado: " + (e.message || e));
    btn.disabled = false; btn.innerText = txt;
  }
}

  // Evento inicial

  window.addEventListener("DOMContentLoaded", () => {
    iniciarEscaneo()
    document.getElementById("stop-btn").addEventListener("click", async () => {
      const btn = document.getElementById("stop-btn");

      if (scanner && escaneoActivo) {
        // Si est√° escaneando: lo detenemos
        try {
          await scanner.stop();
          escaneoActivo = false;
          btn.innerText = "Reiniciar escaneo";
          console.log("üì¥ Escaneo detenido correctamente");
        } catch (err) {
          console.error("‚ùå Error al detener el esc√°ner:", err);
        }
      } else {
        // Si ya est√° detenido: limpiamos todo y volvemos a iniciar
        document.getElementById("detalle-pedido").style.display = "none";
        document.getElementById("tabla-items-despachar").innerHTML = "";
        document.getElementById("cards-items-despachar").innerHTML = "";
        document.getElementById("cliente").innerText = "";
        document.getElementById("estado_envio").innerText = "";
        document.getElementById("shipment_id_hidden").value = "";
        document.getElementById("manual-id").value = "";
        document.getElementById("input-escanear").value = "";

        btn.innerText = "Detener escaneo";
        await iniciarEscaneo();  // üëà Volvemos a activar el esc√°ner
      }
    });


    document.getElementById("input-escanear").addEventListener("change", async e => {
  if (!e.target.files.length) return;
  await detenerEscaneo();
  const qrImg = new Html5Qrcode("reader");
  qrImg.scanFile(e.target.files[0], true)
    .then(decoded => { qrImg.clear(); escanear(decoded); })
    .catch(() => mostrarToastError("No se pudo leer el QR."));
});


    document.getElementById("btn-manual").addEventListener("click", () => {
      const id = document.getElementById("manual-id").value.trim();
      if (id) escanear(id);
    });

    document.getElementById("boton-armar").addEventListener("click", marcarArmado);
    document.getElementById("toast-close-btn")?.addEventListener("click", ocultarToast);

  });
</script>
{% endblock %}