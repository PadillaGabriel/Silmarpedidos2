{% extends "base.html" %}
{% block title %}Escanear Pedido{% endblock %}
{% block content %}
<main>
  <div class="card mb-4">
    <div class="card-body">
      <h2>Escanear Pedido</h2>

      <div id="reader-container" style="display:flex; justify-content:center; margin:1rem auto;">
        <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
      </div>
      <button id="stop-btn" class="btn btn-primary" style="display:block; margin:0 auto;">
        Detener escaneo
      </button>
      <hr style="margin:2rem 0;">

      <p><strong>O sub√≠ una imagen de QR:</strong></p>
      <input type="file" id="input-escanear" accept="image/*" class="mt-1"><br><br>

      <p><strong>O ingres√° el ID manualmente:</strong></p>
      <div style="display:flex; align-items:center;">
        <input
          type="text"
          id="manual-id"
          placeholder="Ingresar ID de pedido"
          style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"
        >
        <button class="btn btn-primary" id="btn-manual" style="margin-left:1rem;">
          Buscar
        </button>
      </div>
    </div>
  </div>

  <div id="detalle-pedido" class="card" style="display:none; margin-top:2rem;">
    <div class="card-body">
      <h3>Detalle del Pedido</h3>
      <p><strong>Cliente:</strong> <span id="cliente" class="badge bg-secondary"></span></p>
      <p><strong>Estado del Env√≠o:</strong> <span id="estado_envio" class="badge"></span></p>
<!-- Tabla solo visible en escritorio -->
<table class="desktop-only" style="width:100%; border-collapse:collapse;">
  <thead>
    <tr>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Imagen</th>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">T√≠tulo</th>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">SKU</th>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Alfa</th>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Cantidad</th>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Variante</th>
      <th style="padding:0.5rem; border-bottom:1px solid #ccc;">Checklist</th>
    </tr>
  </thead>
  <tbody id="tabla-items-despachar"></tbody>
</table>

<!-- Tarjetas solo visibles en celular -->


      <div id="cards-items-despachar" class="mobile-only"></div>
      <div style="text-align:center; margin-top:1rem;">
        <button id="boton-armar" class="btn btn-primary" style="display:none; width:100%;" disabled>
          Marcar como armado
        </button>
      </div>
      <input type="hidden" id="shipment_id_hidden">
      <div id="message-armar" class="mt-2"></div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script src="/static/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// static/escanear.js
let scanner;
let escaneoActivo = false;
let ultimoShipId = "";

// Mostrar popup de error
function mostrarToastError(mensaje) {
  const toast = document.getElementById("toast-alert");
  const body = document.getElementById("toast-body");
  body.innerText = mensaje;
  toast.classList.add("show");
  toast.style.display = "block";
}

// Cerrar popup
function ocultarToast() {
  const toast = document.getElementById("toast-alert");
  toast.classList.remove("show");
  toast.style.display = "none";
}

// Iniciar escaneo con c√°mara
async function iniciarEscaneo() {
  if (!scanner) scanner = new Html5Qrcode("reader");
  escaneoActivo = true;
  try {
await scanner.start(
  { facingMode: "environment" },
  {
    fps: 10,
    qrbox: { width: 300, height: 360 },
    rememberLastUsedCamera: true,
    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
  },
  async decodedText => {
    console.log("‚úÖ QR le√≠do:", decodedText);
    await detenerEscaneo();
    await escanear(decodedText);
  },
  errorMessage => {
    // pod√©s comentar este log si molesta
    // console.warn("No detectado:", errorMessage);
  }
);

    document.getElementById("stop-btn").innerText = "Detener escaneo";
  } catch (err) {
    console.error("‚ùå Error iniciando escaneo:", err);
    escaneoActivo = false;
  }
}

// Detener escaneo
async function detenerEscaneo() {
  if (!scanner) return;
  try {
    await scanner.stop();
    escaneoActivo = false;
    document.getElementById("stop-btn").innerText = "Reiniciar escaneo";
  } catch (err) {
    console.error("‚ùå Error al detener escaneo:", err);
  }
}

// Escanear desde texto o QR
async function escanear(raw) {
  const { shipment_id } = parseQr(raw);
  if (!shipment_id) return mostrarToastError("No se detect√≥ shipment_id v√°lido.");

  ultimoShipId = shipment_id;

  const form = new FormData();
  form.append("shipment_id", shipment_id);

  try {
    const res = await fetch("/escanear", { method: "POST", body: form, credentials: "include" });
    const data = await res.json();
    if (!data.success) return mostrarToastError(data.error || "Error al escanear.");

    renderDetalle(data.detalle);
  } catch (err) {
    console.error(err);
    mostrarToastError("Error al conectar con el servidor.");
  }
}

// Parseo de QR: JSON o URL o ID
function parseQr(decoded) {
  let shipment_id = null;
  if (decoded.trim().startsWith("{")) {
    try {
      const obj = JSON.parse(decoded);
      if (obj.id) shipment_id = obj.id;
    } catch {}
  } else {
    try {
      const url = new URL(decoded);
      const parts = url.pathname.split("/").filter(p => p);
      if (parts[0] === "shipments") shipment_id = parts[1];
    } catch {
      shipment_id = decoded.trim();
    }
  }
  return { shipment_id };
}

// Renderizar detalle + checklist
function renderDetalle(detalle) {
  const tabla = document.getElementById("tabla-items-despachar");
  const cards = document.getElementById("cards-items-despachar");
  tabla.innerHTML = "";
  cards.innerHTML = "";

  document.getElementById("shipment_id_hidden").value = detalle.primer_shipment_id || "";
  document.getElementById("cliente").innerText = detalle.cliente || "-";
  document.getElementById("estado_envio").innerText = detalle.estado_envio || "-";
  document.getElementById("detalle-pedido").style.display = "block";

  detalle.items.forEach(item => {
    const imgUrl = (Array.isArray(item.imagenes) && item.imagenes.length)
      ? (item.imagenes[0].secure_url || item.imagenes[0].url || item.imagenes[0].thumbnail)
      : "https://via.placeholder.com/300";

    // Tarjeta (mobile)
    const card = document.createElement("div");
    card.className = "detalle-card";
    card.innerHTML = `
      <div class="detalle-titulo">${item.titulo}</div>
      <a href="${item.permalink}" target="_blank">
        <img src="${imgUrl}" alt="Imagen del producto" class="img-publicacion">
      </a>
      <div class="detalle-info">
        <div><strong>SKU:</strong> ${item.sku}</div>
        <div><strong>Alfa:</strong> ${item.codigo_proveedor || "-"}</div>
        <div><strong>Cantidad:</strong> ${item.cantidad}</div>
        <div><strong>Variante:</strong> ${item.variante || "-"}</div>
        <div style="margin-top: 0.5rem;">
          <label>
            <input type="checkbox" class="check-item"
              data-item-id="${item.item_id}"
              data-sku="${item.sku || ''}">
            Marcar como armado
          </label>
        </div>
      </div>
    `;
    cards.appendChild(card);

    // Fila de tabla (desktop)
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>
        <a href="${item.permalink}" target="_blank">
          <img src="${imgUrl}" style="width:60px; border-radius:4px;" class="img-publicacion">
        </a>
      </td>
      <td>${item.titulo}</td>
      <td>${item.sku}</td>
      <td>${item.codigo_proveedor || "-"}</td>
      <td>${item.cantidad}</td>
      <td>${item.variante || "-"}</td>
      <td>
        <input type="checkbox" class="check-item"
          data-item-id="${item.item_id}"
          data-sku="${item.sku || ''}">
      </td>
    `;
    tabla.appendChild(row);
  });

  // Guardar estado de los checkbox sin validar
  document.querySelectorAll(".check-item").forEach(input => {
    input.addEventListener("change", () => {
      const shipmentId = document.getElementById("shipment_id_hidden").value;
      const itemId = input.dataset.itemId;
      const marcado = input.checked;

      // sincronizar todos los check con mismo item_id
      document.querySelectorAll(`.check-item[data-item-id="${itemId}"]`).forEach(other => {
        if (other !== input) other.checked = marcado;
      });

      guardarChecklist(shipmentId, itemId, marcado);
    });
  });

  document.getElementById("boton-armar").style.display = "block";
  document.getElementById("boton-armar").disabled = false; // üîì Siempre habilitado
}

function guardarChecklist(shipmentId, itemId, marcado) {
  const f = new FormData();
  f.append("shipment_id", shipmentId);
  f.append("item_id", itemId);
  f.append("marcado", marcado);

  fetch("/checklist", {
    method: "POST",
    body: f,
    credentials: "include"
  }).then(r => r.json()).then(d => {
    if (!d.success) console.warn("‚ùå Checklist error:", d.error);
  });
}



// Validar si todos los checkbox est√°n marcados
function validarChecklist() {
  const checks = document.querySelectorAll(".check-item");
  const todos = Array.from(checks).every(c => c.checked);
  document.getElementById("boton-armar").disabled = !todos;
}

// Guardar checklist parcial
function guardarChecklist(shipmentId, itemId, marcado) {
  const f = new FormData();
  f.append("shipment_id", shipmentId);
  f.append("item_id", itemId);
  f.append("marcado", marcado);

  fetch("/checklist", {
    method: "POST",
    body: f,
    credentials: "include"
  }).then(r => r.json()).then(d => {
    if (!d.success) console.warn("‚ùå Checklist error:", d.error);
  });
}

// Marcar como armado
function marcarArmado() {
  if (!ultimoShipId) return mostrarToastError("No hay shipment_id v√°lido.");

  const f = new FormData();
  f.append("shipment_id", ultimoShipId);

  fetch("/armar", { method: "POST", body: f, credentials: "include" })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        mostrarToastError("‚úÖ Pedido marcado como armado.");
        setTimeout(() => location.reload(), 2000);
      } else {
        mostrarToastError(data.error || "No se pudo marcar como armado.");
      }
    }).catch(() => {
      mostrarToastError("Error al conectar con el servidor.");
    });
}

// Evento inicial
window.addEventListener("DOMContentLoaded", () => {
  iniciarEscaneo();

  document.getElementById("stop-btn").addEventListener("click", () => {
    if (escaneoActivo) detenerEscaneo();
    else iniciarEscaneo();
  });

  document.getElementById("input-escanear").addEventListener("change", e => {
    if (!e.target.files.length) return;
    const qrImg = new Html5Qrcode("reader");
    qrImg.scanFile(e.target.files[0], true)
      .then(decoded => { qrImg.clear(); escanear(decoded); })
      .catch(() => mostrarToastError("No se pudo leer el QR."));
  });

  document.getElementById("btn-manual").addEventListener("click", () => {
    const id = document.getElementById("manual-id").value.trim();
    if (id) escanear(id);
  });

  document.getElementById("boton-armar").addEventListener("click", marcarArmado);
  document.getElementById("toast-close-btn").addEventListener("click", ocultarToast);
});
</script>
{% endblock %}