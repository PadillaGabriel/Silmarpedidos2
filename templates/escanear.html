{% extends "base.html" %}
{% block title %}Escanear Pedido{% endblock %}
{% block content %}
<main>
  <div class="card mb-4">
    <div class="card-body">
      <h2>Escanear Pedido</h2>

      <div id="reader-container" style="display:flex; justify-content:center; margin:1rem auto;">
        <div id="reader" style="width:100%; max-width:360px; aspect-ratio:4/3; border:1px solid #ccc; border-radius:8px;"></div>
      </div>
       <button id="stop-btn" class="btn btn-primary" style="display:block; margin:0 auto;">
        Detener escaneo
      </button>
      <hr style="margin:2rem 0;">

      <p><strong>O sub√≠ una imagen de QR:</strong></p>
      <input type="file" id="input-escanear" accept="image/*" class="mt-1"><br><br>

      <p><strong>O ingres√° el ID manualmente:</strong></p>
      <div style="display:flex; align-items:center;">
        <input
          type="text"
          id="manual-id"
          placeholder="Ingresar ID de pedido"
          style="flex:1; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"
        >
        <button class="btn btn-primary" id="btn-manual" style="margin-left:1rem;">
          Buscar
        </button>
      </div>
    </div>
  </div>

  <div id="detalle-pedido" class="card" style="display:none; margin-top:2rem;">
    <div class="card-body">
      <h3>Detalle del Pedido</h3>
      <p><strong>Cliente:</strong> <span id="cliente" class="badge bg-secondary"></span></p>
      <p><strong>Estado del Env√≠o:</strong> <span id="estado_envio" class="badge"></span></p>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Checklist</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Imagen</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">T√≠tulo</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">SKU</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Variante</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #ccc;">Cantidad</th>
          </tr>
        </thead>
        <tbody id="tabla-items-despachar"></tbody>
      </table>
     

      <div style="text-align:center; margin-top:1rem;">
        <button id="boton-armar" class="btn btn-primary" style="display:none; width:100%;" disabled>
          Marcar como armado
        </button>
      </div>
      <div id="message-armar" class="mt-2"></div>
    </div>
  </div>
</main>
{% endblock %}
{% block scripts %}
<script src="/static/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  
  let scanner;
  let escaneoActivo = false;
  let ultimoOrderId = "";
  let ultimoShipId = "";

function mostrarToastError(mensaje) {
  const toast = document.getElementById("toast-alert");
  const body = document.getElementById("toast-body");
  const closeBtn = document.getElementById("toast-close-btn");

  body.innerText = mensaje;
  toast.classList.add("show");

  const closeHandler = () => {
    toast.classList.remove("show");
    closeBtn.removeEventListener("click", closeHandler);
  };

  closeBtn.addEventListener("click", closeHandler);
}



  function validarChecklist() {
    const checks = document.querySelectorAll(".check-item");
    const todosMarcados = Array.from(checks).every(c => c.checked);
    document.getElementById("boton-armar").disabled = !todosMarcados;
  }
  
async function iniciarEscaneo() {
  if (!scanner) {
    scanner = new Html5Qrcode("reader");
  }

  escaneoActivo = true;  // üëà Lo movemos arriba para evitar clicks r√°pidos que fallan
  try {
    await scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        console.log("‚úÖ QR le√≠do:", decodedText);
        await detenerEscaneo();
        await escanear(decodedText);
      },
      (errorMessage) => {
        // Lecturas fallidas silenciosas
      }
    );
    document.getElementById("stop-btn").innerText = "Detener escaneo";
    console.log("üé• Escaneo iniciado");
  } catch (err) {
    console.error("‚ùå Error iniciando escaneo:", err);
    escaneoActivo = false;  // üîÅ revertir si fall√≥
  }
}

async function detenerEscaneo() {
  if (scanner) {
    const estado = await scanner.getState();  // ‚Üê ESTADO ACTUAL
    console.log("üì° Estado actual del esc√°ner:", estado);

    if (estado === Html5QrcodeScannerState.SCANNING || estado === "SCANNING") {
      try {
        await scanner.stop();
        escaneoActivo = false;
        document.getElementById("stop-btn").innerText = "Reiniciar escaneo";
        console.log("üì¥ Escaneo detenido correctamente");
      } catch (err) {
        console.error("‚ùå Error al detener escaneo:", err);
      }
    } else {
      console.log("‚ÑπÔ∏è Esc√°ner ya estaba detenido");
    }
  }
}

// Bot√≥n para detener o reiniciar
document.getElementById("stop-btn").addEventListener("click", async () => {
  if (escaneoActivo) {
    await detenerEscaneo();
  } else {
    // Limpiar visual
    document.getElementById("detalle-pedido").style.display = "none";
    document.getElementById("tabla-items-despachar").innerHTML = "";
    document.getElementById("cliente").innerText = "";
    document.getElementById("estado_envio").innerText = "";
    document.getElementById("boton-armar").style.display = "none";
    document.getElementById("boton-armar").disabled = true;

    await iniciarEscaneo();
  }
});

function mostrarDetalle(detalle) {
  document.getElementById("cliente").innerText = detalle.cliente;
  const estadoSpan = document.getElementById("estado_envio");
  estadoSpan.innerText = detalle.estado_envio || "Desconocido";
  estadoSpan.className = "badge";

  switch (detalle.shipment_status) {
    case "cancelled":
      estadoSpan.classList.add("bg-danger");
      break;
    case "delivered":
      estadoSpan.classList.add("bg-success");
      break;
    case "ready_to_ship":
      estadoSpan.classList.add("bg-warning", "text-dark");
      break;
    default:
      estadoSpan.classList.add("bg-secondary");
  }

  const tabla = document.getElementById("tabla-items-despachar");
  tabla.innerHTML = "";

  detalle.items.forEach((item, index) => {
    const imgUrl = Array.isArray(item.imagenes) && item.imagenes.length
      ? item.imagenes[0].thumbnail
      : "https://via.placeholder.com/150";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td style="text-align:center; padding:0.5rem; border-bottom:1px solid #eee;">
        <input type="checkbox" 
          class="check-item"
          data-item-id="${item.item_id}"
          data-variation-id="${item.variation_id || ''}"
          data-index="${index}">
      </td>
      <td style="text-align:center; padding:0.5rem; border-bottom:1px solid #eee;">
        <img src="${imgUrl}" width="80" style="border-radius:4px;">
      </td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">
        ${item.permalink
          ? `<a href="${item.permalink}" target="_blank" style="text-decoration:none; color:#007bff;">${item.titulo}</a>`
          : item.titulo}
      </td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.sku}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.variante}</td>
      <td style="padding:0.5rem; border-bottom:1px solid #eee;">${item.cantidad}</td>
    `;
    tabla.appendChild(row);
  });

  // Reasignar listeners y estado
  ultimoOrderId = detalle.primer_order_id || "";
  document.getElementById("boton-armar").style.display = "block";
  document.getElementById("detalle-pedido").style.display = "block";

  document.querySelectorAll(".check-item").forEach(c => {
    c.addEventListener("change", function () {
      const itemId = this.getAttribute("data-item-id");
      const variationId = this.getAttribute("data-variation-id");
      const marcado = this.checked;

      validarChecklist();
      enviarChecklist(ultimoShipId, itemId, variationId, marcado);
    });
  });

  validarChecklist(); // actualizamos al final
}

function validarChecklist() {
  const checks = document.querySelectorAll(".check-item");
  const todosMarcados = Array.from(checks).every(c => c.checked);
  console.log("‚úîÔ∏è ¬øTodos marcados?:", todosMarcados);
  document.getElementById("boton-armar").disabled = !todosMarcados;
}

function enviarChecklist(shipmentId, itemId, variationId, marcado) {
  const form = new FormData();
  form.append("shipment_id", shipmentId);
  form.append("item_id", itemId);
  form.append("variation_id", variationId);
  form.append("marcado", marcado);

  fetch("/checklist", {
    method: "POST",
    body: form,
    credentials: "include"
  }).then(res => res.json()).then(data => {
    if (!data.success) {
      console.warn("‚ö†Ô∏è No se pudo guardar el checklist:", data.error);
    }
  });
}


async function escanear(raw) {
    let shipmentVal;
    try {
      const obj = JSON.parse(raw);
      shipmentVal = obj.id;
    } catch {
      shipmentVal = raw;
    }

    ultimoShipId = shipmentVal;
    const form = new FormData();
    form.append("shipment_id", shipmentVal);

    try {
      const res = await fetch("/escanear", {
        method: "POST",
        body: form
      });
      const data = await res.json();
      if (data.success) {
        mostrarDetalle(data.detalle);
      } else {
        mostrarToastError(data.error || "No se pudo obtener el pedido.");
      }
    } catch {
      mostrarToastError("Error al obtener detalles del pedido.");
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    iniciarEscaneo();

    document.getElementById("stop-btn").addEventListener("click", async () => {
      const btn = document.getElementById("stop-btn");

      if (escaneoActivo) {
        await scanner.stop();
        escaneoActivo = false;
        btn.innerText = "Reiniciar escaneo";
      } else {
        escaneoActivo = true;
        btn.innerText = "Detener escaneo";
        document.getElementById("detalle-pedido").style.display = "none";
        document.getElementById("tabla-items-despachar").innerHTML = "";
        document.getElementById("cliente").innerText = "";
        document.getElementById("estado_envio").innerText = "";
        document.getElementById("boton-armar").disabled = true;
        iniciarEscaneo();
      }
    });

    document.getElementById("input-escanear").addEventListener("change", async e => {
      if (!e.target.files.length) return;
      const blob = e.target.files[0];
      const form = new FormData(); form.append("frame", blob, blob.name);
      const res = await fetch("/decode-qr", {
        method: "POST",
        body: form,
        credentials: "include"
      });
      const json = await res.json();
      if (json.data) escanear(json.data);
      else mostrarToastError("No se pudo leer el QR.");
    });

    document.getElementById("btn-manual").addEventListener("click", () => {
      const id = document.getElementById("manual-id").value.trim();
      if (!id) return mostrarToastError("Por favor ingres√° un ID de pedido v√°lido.");

      const form = new FormData();
      form.append("shipment_id", id);

      fetch("/escanear", {
        method: "POST",
        body: form,
        credentials: "include"
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            mostrarDetalle(data.detalle);
          } else {
            mostrarToastError(data.error || "No se pudo obtener el pedido.");
          }
        })
        .catch(() => {
          mostrarToastError("Error al conectar con el servidor.");
        });
    });

    document.getElementById("boton-armar").addEventListener("click", async () => {
      if (!ultimoShipId) return mostrarToastError("No hay shipment_id v√°lido.");
      const f = new FormData(); f.append("shipment_id", ultimoShipId);
      try {
        const r = await fetch("/armar", {
          method: "POST",
          body: f,
          credentials: "include"
        });
        const j = await r.json();
        if (j.success) window.location.reload();
        else mostrarToastError(j.error);
      } catch {
        mostrarToastError(j.error || "Ocurri√≥ un error inesperado.");

      }
    });
  });
  </script>
{% endblock %}